<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡è¦ªå­è–èª•è¡Œ | è”¡æ°å®¶æ—</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Cormorant+Garamond:ital,wght@0,600;1,600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        serif: ['Cormorant Garamond', 'serif'],
                    },
                    colors: {
                        primary: '#1a1a1a',
                        secondary: '#4b5563',
                        bg: '#f9fafb',
                        card: '#ffffff',
                        gold: '#c5a059',
                        alert: '#b91c1c',
                        success: '#10b981',
                        christmas: '#15803d'
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        
        .fade-enter { opacity: 0; transform: translateY(5px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.3s ease, transform 0.3s ease; }
        .nav-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        
        .checkbox-wrapper input:checked + div { background-color: #c5a059; border-color: #c5a059; }
        .checkbox-wrapper input:checked + div svg { display: block; }
    </style>
</head>
<body class="text-primary font-sans antialiased pb-28" x-data="tripApp()" x-init="initApp()">

    <div class="fixed top-0 left-0 right-0 z-50 bg-bg/95 backdrop-blur-sm pt-safe-top border-b border-gray-100 transition-all duration-300"
         :class="currentTab === 'itinerary' ? 'h-32' : 'h-16'">
        
        <div class="px-6 h-16 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-serif italic font-bold text-primary tracking-wide">Fukuoka <span class="text-gold">Xmas</span></h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div x-show="showSavedToast" class="text-[10px] text-success font-bold flex items-center bg-green-50 px-2 py-1 rounded-full border border-green-100" style="display: none;" x-transition>
                    <i class="fas fa-check mr-1"></i> å·²å„²å­˜
                </div>
                
                <button @click="toggleEditMode()" 
                        class="px-3 py-1 rounded-full text-xs font-bold transition-all shadow-sm border"
                        :class="isEditing ? 'bg-gold text-white border-gold' : 'bg-white text-gray-500 border-gray-200'">
                    <i class="fas" :class="isEditing ? 'fa-save' : 'fa-pen'"></i>
                    <span x-text="isEditing ? 'å„²å­˜' : 'ç·¨è¼¯'"></span>
                </button>
            </div>
        </div>

        <div x-show="currentTab === 'itinerary'" class="flex overflow-x-auto no-scrollbar px-4 pb-2 space-x-4" x-transition>
            <template x-for="(day, index) in days" :key="index">
                <button 
                    @click="activeDay = index; scrollToTop()"
                    class="flex-shrink-0 flex flex-col items-center justify-center w-12 pb-2 transition-all duration-300 relative"
                    :class="activeDay === index ? 'text-primary' : 'text-gray-400 hover:text-gray-600'">
                    <span class="text-[10px] uppercase font-bold tracking-wider mb-1" x-text="day.shortDate"></span>
                    <span class="text-lg font-serif" :class="activeDay === index ? 'font-bold' : ''" x-text="day.weekday"></span>
                    <div class="absolute bottom-0 w-1 h-1 bg-gold rounded-full" x-show="activeDay === index"></div>
                </button>
            </template>
        </div>
    </div>

    <main class="px-5 transition-all duration-500 min-h-screen" :class="currentTab === 'itinerary' ? 'mt-36' : 'mt-20'" id="main-content">
        
        <div x-show="currentTab === 'itinerary'" x-transition:enter="fade-enter" x-transition:enter-start="fade-enter" x-transition:enter-end="fade-enter-active">
            
            <div class="mb-8 pl-2 border-l-2 border-gold" x-key="activeDay">
                <span class="text-gray-400 text-xs font-bold uppercase tracking-widest block mb-1" x-text="days[activeDay].title.split(':')[0]"></span>
                <template x-if="!isEditing">
                    <h2 class="text-3xl font-serif text-primary leading-none" x-text="days[activeDay].title.split(':')[1]"></h2>
                </template>
                <template x-if="isEditing">
                    <input type="text" x-model="days[activeDay].title" class="text-2xl font-serif text-primary border-b border-gold bg-transparent w-full focus:outline-none mb-2">
                </template>
                
                <template x-if="!isEditing">
                    <p class="text-sm text-gray-500 mt-2 font-light" x-text="days[activeDay].desc"></p>
                </template>
                <template x-if="isEditing">
                    <input type="text" x-model="days[activeDay].desc" class="text-sm text-gray-500 border-b border-gray-200 bg-transparent w-full focus:outline-none mt-2" placeholder="è¼¸å…¥ç•¶æ—¥ç°¡ä»‹...">
                </template>
            </div>

            <div class="relative ml-2 space-y-10 pb-20 border-l border-gray-200">
                <template x-for="(event, idx) in days[activeDay].events" :key="idx">
                    <div class="relative pl-8 group" x-data="{ expanded: false }">
                        <div class="absolute -left-[5px] top-2 w-[10px] h-[10px] rounded-full border-2 border-bg transition-all duration-300"
                             :class="event.isChristmas ? 'bg-christmas' : (event.warning ? 'bg-alert' : 'bg-gold')"></div>
                        
                        <div class="flex flex-wrap items-center gap-3 mb-3">
                            <template x-if="!isEditing">
                                <span class="text-xs font-mono font-bold text-gray-400" x-text="event.time"></span>
                            </template>
                            <template x-if="isEditing">
                                <input type="text" x-model="event.time" class="text-xs font-mono font-bold text-primary border border-gray-300 rounded px-1 w-16" placeholder="00:00">
                            </template>

                            <template x-if="event.isReservation">
                                <span class="text-[9px] text-alert border border-alert px-1.5 py-px rounded-full uppercase font-bold tracking-wide cursor-pointer" @click="if(isEditing) event.isReservation = !event.isReservation">éœ€é ç´„</span>
                            </template>
                            <template x-if="!event.isReservation && isEditing">
                                <span class="text-[9px] text-gray-300 border border-gray-300 px-1.5 py-px rounded-full uppercase font-bold tracking-wide cursor-pointer hover:border-alert hover:text-alert" @click="event.isReservation = true">+é ç´„</span>
                            </template>
                            
                            <template x-if="event.isChristmas">
                                <span class="text-[9px] text-christmas border border-christmas px-1.5 py-px rounded-full uppercase font-bold tracking-wide cursor-pointer" @click="if(isEditing) event.isChristmas = !event.isChristmas">è–èª•</span>
                            </template>
                            
                            <template x-if="isEditing">
                                <button @click="deleteEvent(idx)" class="ml-auto text-alert text-xs hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                            </template>
                        </div>
                        
                        <div class="bg-card rounded-xl overflow-hidden shadow-soft transition-all duration-500">
                            <div class="h-32 w-full bg-gray-100 relative overflow-hidden group/img" @click="if(!isEditing) expanded = !expanded">
                                <img :src="'https://loremflickr.com/800/400/' + (event.imgKey || 'japan,travel') + '/all?lock=' + (activeDay * 100 + idx)" 
                                     class="w-full h-full object-cover opacity-90 grayscale-[20%]" loading="lazy">
                                
                                <div class="absolute bottom-3 right-3 w-8 h-8 rounded-full bg-white text-primary flex items-center justify-center shadow-md z-10">
                                    <i class="fas" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </div>

                                <template x-if="isEditing">
                                    <div class="absolute top-2 right-2 left-2">
                                        <input type="text" x-model="event.mapQuery" class="w-full text-xs p-2 rounded bg-white/90 shadow text-primary focus:outline-none" placeholder="è¼¸å…¥ Google Maps æœå°‹é—œéµå­— (å¦‚: ç¦å²¡å¡”)">
                                    </div>
                                </template>
                                <template x-if="isEditing">
                                    <div class="absolute bottom-2 left-2">
                                        <input type="text" x-model="event.imgKey" class="w-32 text-[10px] p-1 rounded bg-white/80 shadow text-gray-600 focus:outline-none" placeholder="åœ–ç‰‡é—œéµå­— (å¦‚: food)">
                                    </div>
                                </template>
                            </div>
                            
                            <div class="p-5">
                                <template x-if="!isEditing">
                                    <h3 class="font-bold text-lg text-primary mb-1 font-serif tracking-wide" x-text="event.title"></h3>
                                </template>
                                <template x-if="isEditing">
                                    <input type="text" x-model="event.title" class="font-bold text-lg text-primary border-b border-gray-200 w-full mb-2 bg-transparent focus:outline-none" placeholder="è¡Œç¨‹æ¨™é¡Œ">
                                </template>

                                <div class="flex flex-wrap gap-2 mb-2">
                                    <template x-if="!isEditing">
                                        <span class="text-[10px] px-2 py-1 bg-gray-50 text-gray-500 rounded-sm uppercase tracking-wider font-medium" x-text="event.type"></span>
                                    </template>
                                    <template x-if="isEditing">
                                        <input type="text" x-model="event.type" class="text-[10px] bg-gray-50 border border-gray-200 rounded px-1 w-20" placeholder="æ¨™ç±¤ (å¦‚: ç¾é£Ÿ)">
                                    </template>
                                </div>

                                <div x-show="expanded || isEditing" x-collapse>
                                    <div class="mt-4 pt-4 border-t border-gray-100 text-sm text-gray-500 leading-relaxed font-light">
                                        
                                        <template x-if="!isEditing">
                                            <div class="flex items-start gap-2 mb-3">
                                                <i class="fas fa-sticky-note text-gold mt-1"></i>
                                                <div x-html="event.note"></div>
                                            </div>
                                        </template>

                                        <template x-if="isEditing">
                                            <div class="mb-3">
                                                <label class="text-[10px] font-bold text-gray-400 uppercase">å‚™è¨» (æ”¯æ´ HTML)</label>
                                                <textarea x-model="event.note" rows="4" class="w-full p-2 text-sm border border-gray-200 rounded bg-gray-50 focus:outline-none focus:border-gold"></textarea>
                                            </div>
                                        </template>
                                        
                                        <div class="mt-3 relative p-3 bg-gray-50 rounded-lg border border-gray-100">
                                            <p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider flex justify-between">
                                                <span>é™„åŠ åœ–ç‰‡</span>
                                                <template x-if="isEditing && event.attachedImage">
                                                    <button @click="event.attachedImage = null" class="text-alert text-[10px] hover:underline">åˆªé™¤åœ–ç‰‡</button>
                                                </template>
                                            </p>
                                            
                                            <template x-if="event.attachedImage">
                                                <img :src="event.attachedImage" class="w-full rounded border border-gray-200 shadow-sm mb-2">
                                            </template>

                                            <template x-if="isEditing">
                                                <div class="mt-2">
                                                    <label class="flex items-center justify-center w-full px-4 py-2 bg-white text-primary rounded-lg border border-dashed border-gray-300 cursor-pointer hover:border-gold hover:text-gold transition">
                                                        <i class="fas fa-camera mr-2"></i> é¸æ“‡ç…§ç‰‡
                                                        <input type="file" accept="image/*" class="hidden" @change="uploadImage($event, idx)">
                                                    </label>
                                                    <p class="text-[10px] text-gray-400 mt-1 text-center">åœ–ç‰‡æœƒè‡ªå‹•å£“ç¸®ä»¥ç¯€çœç©ºé–“</p>
                                                </div>
                                            </template>
                                        </div>
                                        
                                        <template x-if="!isEditing && event.mapQuery">
                                            <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(event.mapQuery)" target="_blank" 
                                               class="flex items-center justify-center w-full mt-4 py-2.5 text-xs font-bold text-primary bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50 hover:border-gold transition-colors">
                                                <i class="fas fa-location-dot text-alert mr-2"></i> ğŸ“ å°èˆªè‡³æ­¤
                                            </a>
                                        </template>
                                    </div>
                                </div>

                                <template x-if="!isEditing">
                                    <button @click="expanded = !expanded" class="w-full mt-3 py-2 text-xs font-bold text-gray-400 border border-gray-100 rounded hover:bg-gray-50 transition-colors uppercase tracking-widest">
                                        <span x-text="expanded ? 'æ”¶èµ·å‚™è¨»' : 'æŸ¥çœ‹å‚™è¨»'"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <template x-if="isEditing">
                    <button @click="addEvent(activeDay)" class="w-full py-4 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl font-bold hover:border-gold hover:text-gold transition-colors">
                        <i class="fas fa-plus-circle mr-2"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </template>
            </div>
        </div>

        <div x-show="currentTab === 'booking'" x-transition:enter="fade-enter" style="display: none;">
            <div class="mb-8 mt-2">
                <h2 class="text-3xl font-serif text-primary">é ç´„ç®¡ç†</h2>
                <p class="text-sm text-gray-500 mt-1">å¿…åšé ç´„ (ä¾ç…§æ—¥æœŸé †åºæ’åˆ—)</p>
            </div>
            <div class="space-y-4">
                <template x-for="item in sortedReservations" :key="item.id">
                    <label class="checkbox-wrapper bg-white p-5 rounded-lg shadow-soft flex items-start gap-4 cursor-pointer select-none transition-all duration-300"
                           :class="item.ref.booked ? 'opacity-60 grayscale' : 'border-l-4 border-alert'">
                        <div class="pt-1">
                            <input type="checkbox" class="hidden" x-model="item.ref.booked" @change="saveData()">
                            <div class="w-6 h-6 border-2 border-gray-300 rounded-md flex items-center justify-center transition-colors">
                                <svg class="w-4 h-4 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider" x-text="item.dayStr"></div>
                            </div>
                            <h3 class="font-bold text-lg mt-1 transition-all" :class="item.ref.booked ? 'text-gray-400 line-through' : 'text-primary'" x-text="item.ref.title"></h3>
                            <div class="flex items-center gap-2 font-mono text-sm font-bold mt-1 mb-2" :class="item.ref.booked ? 'text-gray-400' : 'text-gold'">
                                <i class="far fa-clock"></i> <span x-text="item.ref.time"></span>
                            </div>
                            <p class="text-sm text-gray-500 font-light truncate" x-text="item.ref.note ? item.ref.note.replace(/<[^>]*>/g, '') : ''"></p>
                        </div>
                    </label>
                </template>
                <div x-show="sortedReservations.length === 0" class="text-center py-10 text-gray-400">
                    ç›®å‰æ²’æœ‰éœ€è¦é ç´„çš„é …ç›®ã€‚
                    <br><span class="text-xs">(åœ¨ç·¨è¼¯æ¨¡å¼ä¸­å‹¾é¸ã€Œ+é ç´„ã€å³å¯åŠ å…¥)</span>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'packing'" x-transition:enter="fade-enter" style="display: none;">
            <div class="mb-8 mt-2">
                <h2 class="text-3xl font-serif text-primary">è¡Œææ¸…å–®</h2>
                <p class="text-sm text-gray-500 mt-1">æª¢æŸ¥ç‹€æ…‹æœƒè‡ªå‹•å„²å­˜</p>
            </div>
            <div class="space-y-6">
                <template x-for="category in packingList">
                    <div>
                        <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1" x-text="category.title"></h4>
                        <div class="bg-white rounded-lg shadow-soft overflow-hidden">
                            <template x-for="item in category.items">
                                <label class="checkbox-wrapper px-5 py-4 border-b border-gray-50 last:border-0 flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition-colors">
                                    <input type="checkbox" class="hidden" x-model="item.checked" @change="saveData()">
                                    <div class="w-5 h-5 border border-gray-300 rounded flex items-center justify-center transition-colors">
                                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                    <span class="text-primary text-sm font-medium transition-all" :class="item.checked ? 'text-gray-300 line-through' : ''" x-text="item.name"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <button @click="resetData()" class="w-full mt-10 py-3 border border-red-200 text-red-400 rounded-lg text-sm hover:bg-red-50 transition mb-6">
                <i class="fas fa-trash-alt mr-2"></i> é‡ç½®æ‰€æœ‰è¨­å®š (æ¸…ç©ºæš«å­˜)
            </button>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-24 nav-glass z-50 flex justify-around items-start pt-4 pb-safe-bottom">
        <button @click="currentTab = 'itinerary'; scrollToTop()" class="flex flex-col items-center justify-center w-1/3 transition-all duration-300 group">
            <div class="w-10 h-10 rounded-full flex items-center justify-center mb-1 transition-all" :class="currentTab === 'itinerary' ? 'bg-primary text-white shadow-lg' : 'text-gray-400 group-hover:bg-gray-100'"><i class="fas fa-map-marked-alt text-sm"></i></div>
            <span class="text-[10px] font-bold tracking-widest uppercase" :class="currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400'">è¡Œç¨‹</span>
        </button>
        <button @click="currentTab = 'booking'; scrollToTop()" class="flex flex-col items-center justify-center w-1/3 transition-all duration-300 group">
            <div class="w-10 h-10 rounded-full flex items-center justify-center mb-1 transition-all relative" :class="currentTab === 'booking' ? 'bg-primary text-white shadow-lg' : 'text-gray-400 group-hover:bg-gray-100'">
                <i class="fas fa-check-circle text-sm"></i>
                <div class="absolute top-0 right-0 w-2.5 h-2.5 bg-alert border-2 border-white rounded-full"></div>
            </div>
            <span class="text-[10px] font-bold tracking-widest uppercase" :class="currentTab === 'booking' ? 'text-primary' : 'text-gray-400'">é ç´„</span>
        </button>
        <button @click="currentTab = 'packing'; scrollToTop()" class="flex flex-col items-center justify-center w-1/3 transition-all duration-300 group">
            <div class="w-10 h-10 rounded-full flex items-center justify-center mb-1 transition-all" :class="currentTab === 'packing' ? 'bg-primary text-white shadow-lg' : 'text-gray-400 group-hover:bg-gray-100'"><i class="fas fa-suitcase-rolling text-sm"></i></div>
            <span class="text-[10px] font-bold tracking-widest uppercase" :class="currentTab === 'packing' ? 'text-primary' : 'text-gray-400'">è¡Œæ</span>
        </button>
    </nav>

    <script>
        // Default Data
        const initialDays = [
            {
                shortDate: '12/12', weekday: 'é€±äº”',
                title: 'Day 1: æŠµé”ç¦å²¡',
                desc: 'Arrival & Christmas Lights',
                specialAlert: 'å»ºè­°ç›´æ¥æ­è¨ˆç¨‹è»Šå‰å¾€ä½å®¿ (Â¥2,000)ã€‚æ™šä¸Šå¯æ•£æ­¥å»çœ‹è—è‰²ç‡ˆæµ·ã€‚',
                events: [
                    { time: '19:35', title: 'æŠµé”ç¦å²¡æ©Ÿå ´', type: 'èˆªç­', imgKey: 'airport,night', note: '<strong>ä¸­è¯èˆªç©º CI116</strong><br>TPE 16:25 â” FUK 19:35<br>å…¥å¢ƒæ‰‹çºŒèˆ‡é ˜è¡Œæã€‚', mapQuery: 'Fukuoka Airport International Terminal' },
                    { time: '21:00', title: 'æ­è¨ˆç¨‹è»Šå‰å¾€ä½å®¿', type: 'äº¤é€š', imgKey: 'taxi,japan', note: 'å‰å¾€ Sumiyoshi apartmentã€‚', mapQuery: 'Sumiyoshi, Hakata Ward' },
                    { time: '21:30', title: 'Sumiyoshi apartment', type: 'ä½å®¿', imgKey: 'apartment,interior', note: 'è¾¦ç†å…¥ä½ã€‚', mapQuery: 'Sumiyoshi apartment' },
                    { time: '22:00', title: 'åšå¤šè»Šç«™å…‰ä¹‹è¡—', type: 'è–èª•', imgKey: 'christmas,lights', note: 'è—è‰²ç‡ˆæµ·æ•£æ­¥ (Hikari no Machi)ï¼Œæ„Ÿå—è–èª•æ°£æ°›ã€‚', isChristmas: true, mapQuery: 'JR Hakata Station' }
                ]
            },
            {
                shortDate: '12/13', weekday: 'é€±å…­',
                title: 'Day 2: è¦ªå­ & æ½®æµ',
                desc: 'Toys, Hotpot & Streetwear',
                specialAlert: 'ä¸­åˆé¤å»³å‹™å¿…é ç´„ã€‚ä¸‹åˆè¡Œç¨‹åŒ…å«è–èª•å¸‚é›†èˆ‡éºµåŒ…ååº—ã€‚',
                events: [
                    { time: '08:30', title: 'Fuk Coffee', type: 'å’–å•¡', imgKey: 'coffee,latte', note: 'æ™¨é–“å’–å•¡æ™‚å…‰ã€‚', mapQuery: 'FUK COFFEE Parks' },
                    { time: '10:00', title: 'ç¦å²¡ç©å…·ç¾è¡“é¤¨', type: 'é«”é©—', imgKey: 'woodentoy', note: 'LaLaport 1Fï¼Œé–‹é–€å³å…¥å ´ã€‚', mapQuery: 'Fukuoka Toy Museum' },
                    { time: '12:45', title: 'åšå¤šè¯å‘³é³¥ (åšå¤šç«™å‰)', type: 'åˆé¤', imgKey: 'hotpot,chicken', note: 'åˆé–“é™å®šæ°´ç‚Šå¾¡è†³ã€‚', mapQuery: 'Hakata Hanamidori Hakata Station', isReservation: true, booked: false },
                    { time: '14:45', title: 'å¤©ç¥å¤§åæ½®æµå€', type: 'è³¼ç‰©', imgKey: 'streetwear', note: 'Supreme, Neighborhood, Stussyã€‚', mapQuery: 'Supreme Fukuoka' },
                    { time: '16:00', title: 'THE FULL FULL TENJIN', type: 'ç¾é£Ÿ', imgKey: 'bakery,bread', note: 'æ˜å¤ªå­æ³•åœ‹éºµåŒ…ååº—ï¼Œé©åˆä¸‹åˆèŒ¶ã€‚', mapQuery: 'THE FULL FULL TENJIN', isReservation: true, booked: false },
                    { time: '16:45', title: 'å¤§åèŠ±åœ’åŸè–èª•å¸‚é›†', type: 'è–èª•', imgKey: 'christmas,market', note: 'Christmas Gate å¸‚é›†ï¼Œå–æ¯ç†±ç´…é…’ä¼‘æ¯ã€‚', isChristmas: true, mapQuery: 'Fukuoka Daimyo Garden City' },
                    { time: '19:30', title: 'Sky Rental Store å–è»Š', type: 'ç§Ÿè»Š', imgKey: 'car,keys', note: 'è¨­å®šå¾€é«˜åƒç©—çš„å°èˆªã€‚', isReservation: true, booked: false, mapQuery: 'Sky Rental Car Fukuoka' }
                ]
            },
            {
                shortDate: '12/14', weekday: 'é€±æ—¥',
                title: 'Day 3: é«˜åƒç©— & é˜¿è˜‡',
                desc: 'Nature & Volcano',
                specialAlert: '<strong>æ—©é³¥è¡åˆºæ—¥ï¼</strong> 06:30 å‡ºé–€ã€‚å‰å¾€ç”±å¸ƒé™¢å±±è·¯ç„¡è·¯ç‡ˆï¼Œè«‹æ…¢è¡Œã€‚',
                events: [
                    { time: '06:30', title: 'æº–æ™‚å‡ºé–€', type: 'äº¤é€š', imgKey: 'highway,sunrise', note: 'å‰å¾€é«˜åƒç©—ï¼Œè»Šç¨‹ç´„ 3 å°æ™‚ã€‚', warning: true },
                    { time: '09:30', title: 'é«˜åƒç©—å³½ åˆ’èˆ¹', type: 'é«”é©—', imgKey: 'boat,waterfall', note: 'åˆ’èˆ¹ 40 åˆ†é˜ + æ‹ç…§ã€‚', mapQuery: 'Takachiho Gorge Boat Rental', isReservation: true, booked: false },
                    { time: '11:30', title: 'åƒç©—ä¹‹å®¶ æµæ°´éºµ', type: 'åˆé¤', imgKey: 'noodles', mapQuery: 'Chiho no Ie' },
                    { time: '14:00', title: 'é˜¿è˜‡ä¸­å²³ç«å±±å£', type: 'æ™¯é»', imgKey: 'volcano', mapQuery: 'Mount Aso Nakadake Crater' },
                    { time: '15:00', title: 'è‰åƒé‡Œ Green Park', type: 'æ™¯é»', imgKey: 'grassland', mapQuery: 'Kusasenri' },
                    { time: '20:30', title: 'æ¹¯å¸ƒé™¢ è‰¯æ—…å±‹ ETAVIA', type: 'ä½å®¿', imgKey: 'ryokan', mapQuery: 'Yufuin Ryoryoya ETAVIA' }
                ]
            },
            {
                shortDate: '12/15', weekday: 'é€±ä¸€',
                title: 'Day 4: å‹•ç‰©åœ’ & ç¾è¡“é¤¨',
                desc: 'Safari & Art Museum',
                specialAlert: 'æ—©ä¸Šæ¶å¢æ—å·´å£«ç¥¨ï¼Œä¸‹åˆç¾è¡“é¤¨éœ€é ç´„ã€‚',
                events: [
                    { time: '08:30', title: 'ä¹å·è‡ªç„¶å‹•ç‰©åœ’', type: 'é«”é©—', imgKey: 'lion,safari', note: '09:00 é–‹åœ’ï¼Œæ¶æœ€æ—©å ´çš„å¢æ—å·´å£«ã€‚', mapQuery: 'African Safari Japan', isReservation: true, booked: false },
                    { time: '09:30', title: 'å¢æ—å·´å£«é«”é©—', type: 'é«”é©—', imgKey: 'bus,zoo', note: 'é¤µé£Ÿé«”é©—ç´„ 50 åˆ†é˜ã€‚', mapQuery: 'African Safari Japan' },
                    { time: '13:00', title: 'COMICO ART MUSEUM', type: 'è—è¡“', imgKey: 'museum,architecture', note: 'éšˆç ”å¾å»ºç¯‰ï¼Œæ‘ä¸Šéš†ä½œå“ã€‚', mapQuery: 'COMICO ART MUSEUM YUFUIN', isReservation: true, booked: false },
                    { time: '14:00', title: 'æ¹¯ä¹‹åªè¡—é“ & é‡‘é±—æ¹–', type: 'æ™¯é»', imgKey: 'lake,mist', note: 'è³¼è²· B-Speak è›‹ç³•æ²ã€‚', mapQuery: 'Kinrin Lake' },
                    { time: '18:30', title: 'ç‡’è‚‰ å¤šç‰› (åšå¤šç«™å—)', type: 'æ™šé¤', imgKey: 'yakiniku', note: 'CPå€¼æ¥µé«˜å’Œç‰›ï¼Œéœ€ç¾å ´æ’éšŠã€‚', mapQuery: 'Yakiniku Tagyu Hakata' }
                ]
            },
            {
                shortDate: '12/16', weekday: 'é€±äºŒ',
                title: 'Day 5: ç³¸å³¶æµ·ç·š',
                desc: 'Strawberry & Seaside',
                specialAlert: 'æ—©ä¸Šå…ˆæ¡è‰è“ (å·²é ç´„)ã€‚æ™šä¸Šé‚„è»Šå‰è¨˜å¾—åŠ æ²¹ã€‚',
                events: [
                    { time: '09:30', title: 'Itoshima Berry Farm', type: 'é«”é©—', imgKey: 'strawberry', note: 'æ¡è‰è“é«”é©—ã€‚', mapQuery: 'Itoshima Berry Farm', isReservation: true, booked: false },
                    { time: '12:00', title: 'æµ·é®®é¤å»³ Futamigaura', type: 'åˆé¤', imgKey: 'seafood,ocean', note: 'æµ·æ™¯ç¬¬ä¸€æ’åˆé¤ã€‚', mapQuery: 'Itoshima Seafood Restaurant Futamigaura' },
                    { time: '13:30', title: 'èŠ±é¹½å¸ƒä¸ & è§€å…‰èˆ¹', type: 'æ™¯é»', imgKey: 'pudding', note: 'è¦–é¢¨æµªæ±ºå®šæ˜¯å¦æ­èŠ¥å±‹å¤§é–€è§€å…‰èˆ¹ã€‚', mapQuery: 'Mataichi no Shio' },
                    { time: '19:30', title: 'Sky Rental Store é‚„è»Š', type: 'ç§Ÿè»Š', imgKey: 'car,gas', note: 'é‚„è»Šå‰è«‹åŠ æ»¿æ²¹ã€‚', mapQuery: 'Sky Rental Car Fukuoka' },
                    { time: '20:00', title: 'è³‡æ¡‘çƒé¾éºµ', type: 'æ™šé¤', imgKey: 'udon', note: 'æ¨è–¦ï¼šè‚‰ç‰›è’¡å¤©å©¦ç¾…çƒé¾éºµã€‚', mapQuery: 'Sukesan Udon' }
                ]
            },
            {
                shortDate: '12/17', weekday: 'é€±ä¸‰',
                title: 'Day 6: å¤ªå®°åºœé›»è»Šæ—…',
                desc: 'Shrine, Market & Yatai',
                specialAlert: 'å¤ªå®°åºœé›»è»Šè¼•é¬†éŠã€‚æ™šä¸Šé€›å¤©ç¥è–èª•å¸‚é›†èˆ‡ä¸­æ´²å¤œæ™¯ã€‚',
                events: [
                    { time: '10:00', title: 'å‰å¾€å¤ªå®°åºœ', type: 'äº¤é€š', imgKey: 'train,japan', note: 'å¤©ç¥ç«™æ­ä¹˜è¥¿éµé›»è»Šã€‚', mapQuery: 'Nishitetsu Fukuoka (Tenjin) Station' },
                    { time: '11:00', title: 'å¤ªå®°åºœè¡¨åƒé“', type: 'æ™¯é»', imgKey: 'starbucks,japan', note: 'åƒæ¢…æé¤…ã€é€›æ˜Ÿå·´å…‹æ¦‚å¿µåº—ã€‚', mapQuery: 'Dazaifu Tenmangu Omotesando' },
                    { time: '13:30', title: 'å¤ªå®°åºœå¤©æ»¿å®®', type: 'æ™¯é»', imgKey: 'shrine,bull', note: 'åƒæ‹œå­¸å•ä¹‹ç¥ã€‚', mapQuery: 'Dazaifu Tenmangu' },
                    { time: '14:30', title: 'å¤ªå®°åºœéŠæ¨‚åœ’', type: 'é«”é©—', imgKey: 'amusementpark', note: 'å¾©å¤æ¨‚åœ’ï¼Œå°å­©æ”¾é›»ã€‚', mapQuery: 'Dazaifu Amusement Park' },
                    { time: '17:40', title: 'å¤©ç¥è–èª•å¸‚é›†', type: 'è–èª•', imgKey: 'christmas,santa', note: 'å¸‚å½¹æ‰€å‰å»£å ´ï¼Œæ°£æ°›æœ€ç†±é¬§ã€‚', isChristmas: true, mapQuery: 'Fukuoka City Hall' },
                    { time: '18:30', title: 'å¤©ç¥å±‹å° å°é‡‘ã¡ã‚ƒã‚“', type: 'æ™šé¤', imgKey: 'foodstall', note: 'é«”é©—ç‚’æ‹‰éºµã€‚', mapQuery: 'Kokinchantei' },
                    { time: '20:00', title: 'ä¸­æ´²å…‰ä¹‹å¤§é“', type: 'è–èª•', imgKey: 'night,river', note: 'é‚£ç‚å·æ²¿å²¸é‡‘è‰²ç‡ˆé£¾æ•£æ­¥ã€‚', isChristmas: true, mapQuery: 'Nakasu' }
                ]
            },
            {
                shortDate: '12/18', weekday: 'é€±å››',
                title: 'Day 7: è–èª•å¸‚é›†å£“è»¸',
                desc: 'Anpanman & Hakata Xmas',
                specialAlert: 'éºµåŒ…è¶…äººé¤¨å…§è§£æ±ºåˆé¤æœ€æ–¹ä¾¿ã€‚æ™šä¸Šåšå¤šç«™è–èª•å¸‚é›†ã€‚',
                events: [
                    { time: '10:00', title: 'éºµåŒ…è¶…äººåšç‰©é¤¨', type: 'é«”é©—', imgKey: 'anpanman', note: 'åˆé¤æ–¼é¤¨å…§äº«ç”¨ã€‚', mapQuery: 'Fukuoka Anpanman Children\'s Museum' },
                    { time: '16:00', title: 'åšå¤šé‹æ²³åŸ', type: 'è³¼ç‰©', imgKey: 'fountain', note: 'è§€è³è–èª•æ°´èˆç§€ã€‚', mapQuery: 'Canal City Hakata' },
                    { time: '18:30', title: 'åšå¤šè»Šç«™è–èª•å¸‚é›†', type: 'è–èª•', imgKey: 'christmasmarket,night', note: 'æ—…ç¨‹å£“è»¸ï¼ç†±ç´…é…’ã€ç¾é£Ÿèˆ‡éŸ³æ¨‚è¡¨æ¼”ã€‚', isChristmas: true, mapQuery: 'JR Hakata Station' }
                ]
            },
            {
                shortDate: '12/19', weekday: 'é€±äº”',
                title: 'Day 8: æœ€å¾Œè¡åˆº',
                desc: 'Shopping & Buddha',
                specialAlert: 'æ—©ä¸Šå…ˆå¯„æ”¾è¡Œæï¼Œåˆ©ç”¨åœ°éµç§»å‹•ã€‚',
                events: [
                    { time: '09:00', title: 'é€€æˆ¿ & å¯„æ”¾è¡Œæ', type: 'äº¤é€š', imgKey: 'luggage', note: 'æ­è¨ˆç¨‹è»Šè‡³åšå¤šè»Šç«™ç½®ç‰©æ«ƒå¯„æ”¾ã€‚', mapQuery: 'Hakata Station' },
                    { time: '09:30', title: 'æ±é•·å¯º (ç¦å²¡å¤§ä½›)', type: 'æ™¯é»', imgKey: 'buddha', note: 'åœ°éµç¥‡åœ’ç«™ã€‚åƒè§€æœ¨é€ å¤§ä½›ã€‚', mapQuery: 'Tochoji Temple' },
                    { time: '10:30', title: 'å¤§æ¿ å…¬åœ’ & ç¦å²¡åŸè·¡', type: 'æ™¯é»', imgKey: 'park,lake', note: 'æ˜Ÿå·´å…‹å–å’–å•¡ã€çœ‹è‰é–“å½Œç”Ÿå—ç“œã€‚', mapQuery: 'Ohori Park' },
                    { time: '12:15', title: 'åšå¤šä¸€åŒæ‹‰éºµ', type: 'åˆé¤', imgKey: 'ramen,bubbles', note: 'æœ€å¾Œåˆé¤ (åšå¤šé§…æ±æœ¬åº—)ã€‚', mapQuery: 'Hakata Issou' },
                    { time: '14:00', title: 'åšå¤šç«™ä¼´æ‰‹ç¦®è¡åˆº', type: 'è³¼ç‰©', imgKey: 'souvenir,japan', note: 'Ming æˆ– é˜ªæ€¥åœ°ä¸‹è¡—ã€‚å¿…è²·ï¼šåŠªåŠªé›ã€Menbeiã€‚', mapQuery: 'Ming Hakata' },
                    { time: '16:00', title: 'ç‡•å­æ—å»£å ´ (RF)', type: 'æ™¯é»', imgKey: 'rooftop,city', note: 'ä¿¯ç°ç¦å²¡å¸‚æ™¯ã€‚', mapQuery: 'JR Hakata City Rooftop' },
                    { time: '17:00', title: 'å‰å¾€ç¦å²¡æ©Ÿå ´', type: 'äº¤é€š', imgKey: 'airport,taxi', note: 'æ­è¨ˆç¨‹è»Šå‰å¾€æœ€çœåŠ›ã€‚', mapQuery: 'Fukuoka Airport International Terminal' },
                    { time: '20:35', title: 'ç­æ©Ÿèµ·é£›', type: 'èˆªç­', imgKey: 'airplane', note: '<strong>ä¸­è¯èˆªç©º CI117</strong><br>FUK 20:35 â” TPE 22:20<br>å¹³å®‰è¿”å°ã€‚' }
                ]
            }
        ];

        function tripApp() {
            return {
                currentTab: 'itinerary',
                activeDay: 0,
                showSavedToast: false,
                isEditing: false,
                days: initialDays, // Will be overwritten by localStorage if exists

                // Computed property for sorted reservations
                get sortedReservations() {
                    let list = [];
                    this.days.forEach((day, dIdx) => {
                        day.events.forEach((event, eIdx) => {
                            if(event.isReservation) {
                                list.push({
                                    id: `${dIdx}-${eIdx}`,
                                    dayStr: `Day ${dIdx + 1} Â· ${day.shortDate}`,
                                    ref: event 
                                });
                            }
                        });
                    });
                    // Since we iterate days in order, this list is naturally sorted by date/time
                    return list;
                },

                initApp() {
                    const savedData = localStorage.getItem('fukuoka_trip_data_v7');
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            // Deep merge or overwrite if structure matches
                            if(parsed.days) this.days = parsed.days;
                            if(parsed.packingList) this.packingList = parsed.packingList;
                        } catch (e) {
                            console.error('Data restore failed', e);
                        }
                    }
                },

                toggleEditMode() {
                    this.isEditing = !this.isEditing;
                    if(!this.isEditing) {
                        this.saveData();
                    }
                },

                addEvent(dayIndex) {
                    this.days[dayIndex].events.push({
                        time: '00:00',
                        title: 'æ–°è¡Œç¨‹',
                        type: 'è‡ªè¨‚',
                        note: 'è«‹è¼¸å…¥å‚™è¨»...',
                        imgKey: 'travel',
                        isReservation: false,
                        mapQuery: ''
                    });
                },

                deleteEvent(eventIndex) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) {
                        this.days[this.activeDay].events.splice(eventIndex, 1);
                    }
                },

                // Image Upload Logic with Compression
                uploadImage(event, eventIndex) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Compress logic: max width 800px
                            const maxWidth = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            // Compress to JPEG 0.7 quality
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            this.days[this.activeDay].events[eventIndex].attachedImage = dataUrl;
                            this.saveData(); // Save immediately
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                saveData() {
                    const dataToSave = {
                        days: this.days,
                        packingList: this.packingList
                    };
                    // v7 key for new structure
                    localStorage.setItem('fukuoka_trip_data_v7', JSON.stringify(dataToSave));
                    this.showSavedToast = true;
                    setTimeout(() => { this.showSavedToast = false; }, 2000);
                },

                resetData() {
                    if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ(åŒ…å«æ‚¨ä¸Šå‚³çš„ç…§ç‰‡èˆ‡æ–°å¢çš„è¡Œç¨‹)')) {
                        localStorage.removeItem('fukuoka_trip_data_v7');
                        location.reload();
                    }
                },

                scrollToTop() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                packingList: [
                    {
                        title: 'é‡è¦æ–‡ä»¶',
                        items: [
                            { name: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', checked: false },
                            { name: 'VJW QR Code æˆªåœ–', checked: false },
                            { name: 'å°ç£é§•ç…§æ­£æœ¬', checked: false },
                            { name: 'æ—¥æ–‡é§•ç…§è­¯æœ¬', checked: false },
                            { name: 'æ©Ÿç¥¨/è¨‚æˆ¿æ†‘è­‰', checked: false }
                        ]
                    },
                    {
                        title: 'é‡‘éŒ¢èˆ‡ç¶²è·¯',
                        items: [
                            { name: 'æ—¥å¹£ç¾é‡‘', checked: false },
                            { name: 'ä¿¡ç”¨å¡ (æµ·å¤–å›é¥‹)', checked: false },
                            { name: 'Simå¡ / æ¼«éŠè¨­å®š', checked: false }
                        ]
                    },
                    {
                        title: 'éš¨èº«ç”¨å“',
                        items: [
                            { name: 'è¡Œå‹•é›»æº', checked: false },
                            { name: 'å……é›»ç·š/æ’é ­', checked: false },
                            { name: 'å€‹äººè—¥å“', checked: false },
                            { name: 'å¥½èµ°çš„é‹å­', checked: false }
                        ]
                    }
                ]
            }
        }
    </script>
</body>
</html>
